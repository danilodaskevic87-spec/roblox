<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>–°–∞–π—Ç</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- ‚úÖ Supabase –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:Arial;background:#0b1220;color:#e5e7eb}
.hidden{display:none}
.container{max-width:900px;margin:40px auto;padding:20px}
.card{
  background:#020617;border-radius:22px;padding:25px;
  margin-bottom:25px;box-shadow:0 25px 60px rgba(0,0,0,.7)
}
input,select,button{
  width:100%;padding:14px;margin-top:10px;
  border-radius:14px;border:none
}
input,select{background:#0f172a;color:white;border:1px solid #1e293b}
button{background:#6366f1;color:white;font-weight:bold;cursor:pointer}
button:disabled{background:#334155;color:#94a3b8;cursor:not-allowed}
.error{color:#f87171;font-size:14px;margin-top:6px}
.balance-box{display:flex;justify-content:space-between;gap:20px}
.shop-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px}
.product{background:#020617;padding:20px;border-radius:18px}
.price{color:#38bdf8;font-size:22px}

/* overlay */
.overlay{
  position:fixed;inset:0;background:rgba(2,6,23,.7);
  backdrop-filter:blur(6px);display:none;
  align-items:center;justify-content:center;z-index:999
}
.loader{
  width:50px;height:50px;border:4px solid #1e293b;
  border-top-color:#6366f1;border-radius:50%;
  animation:spin 1s linear infinite
}
@keyframes spin{to{transform:rotate(360deg)}}

/* confetti */
.confetti{position:fixed;inset:0;pointer-events:none;z-index:1000}
.confetti span{
  position:absolute;width:10px;height:14px;
  animation:fall linear forwards
}
@keyframes fall{
  from{transform:translateY(-10vh) rotate(0)}
  to{transform:translateY(110vh) rotate(720deg)}
}
</style>
</head>
<body>

<div class="container">

<!-- LOGIN -->
<div class="card" id="loginView">
  <h2>–í—Ö—ñ–¥</h2>
  <input id="loginLogin" placeholder="–ù—ñ–∫ –∞–±–æ ID">
  <input id="loginPassword" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
  <button onclick="login()">–£–≤—ñ–π—Ç–∏</button>
  <div class="error" id="loginError"></div>
  <p style="text-align:center">
    <a href="#" onclick="showRegister()" style="color:#38bdf8">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</a>
  </p>
</div>

<!-- REGISTER -->
<div class="card hidden" id="registerView">
  <h2>–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</h2>
  <input id="regLogin" placeholder="–ù—ñ–∫ –∞–±–æ ID">
  <input id="regPassword" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
  <button onclick="register()">–°—Ç–≤–æ—Ä–∏—Ç–∏</button>
  <div class="error" id="regError"></div>
  <p style="text-align:center">
    <a href="#" onclick="showLogin()" style="color:#38bdf8">–ù–∞–∑–∞–¥</a>
  </p>
</div>

<!-- PROFILE -->
<div class="hidden" id="profileView">

  <div class="card balance-box">
    <div>–û—Å–æ–±–∏—Å—Ç–∏–π<br><b><span id="personal">0</span> R$</b></div>
    <div>–§–∞—Ä–º–∏–ª–∫–∞<br><b style="color:#22c55e"><span id="farming">0</span> R$</b></div>
  </div>

  <div class="card">
    <h2>–ú–∞–≥–∞–∑–∏–Ω</h2>
    <div class="shop-grid" id="shop"></div>
  </div>

  <div class="card">
    <h2>–ó–Ω—è—Ç–∏</h2>
    <select id="withdrawBalance">
      <option value="personal">–û—Å–æ–±–∏—Å—Ç–∏–π –±–∞–ª–∞–Ω—Å</option>
      <option value="farming">–ë–∞–ª–∞–Ω—Å —Ñ–∞—Ä–º–∏–ª–∫–∏</option>
    </select>
    <input id="robloxNick" placeholder="Roblox –Ω—ñ–∫">
    <input id="withdrawAmount" type="number" placeholder="–°—É–º–∞">
    <button onclick="withdraw()">–ó–Ω—è—Ç–∏</button>
    <div class="error" id="withdrawError"></div>
  </div>

  <button onclick="logout()" style="background:#dc2626">–í–∏–π—Ç–∏</button>
</div>

</div>

<div class="overlay" id="overlay"><div class="loader"></div></div>
<div class="confetti" id="confetti"></div>

<script>
/* ======================================================
   üîë –¢–£–¢ –ü–ò–®–ï–® ANON KEY –Ü URL
   ====================================================== */

const supabase = supabase.createClient(
  "https://yknskbeqyahkxwceqflr.supabase.co",   // ‚Üê –°–Æ–î–ò –≤—Å—Ç–∞–≤ URL
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlrbnNrYmVxeWFoa3h3Y2VxZmxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5NzA1OTAsImV4cCI6MjA4NDU0NjU5MH0.UaGcGRMdcPHv9bujNEtSjoL6OYy6XnmpxgWR9W2029M"                     // ‚Üê –°–Æ–î–ò –≤—Å—Ç–∞–≤ ANON KEY
);

/* ====================================================== */

let userId = localStorage.getItem("user_id");
let balances = { personal:0, farming:0 };
let limits = {
  personal_limit:0, farming_limit:0,
  personal_used:0, farming_used:0
};

/* VIEW */
function showLogin(){loginView.classList.remove("hidden");registerView.classList.add("hidden")}
function showRegister(){loginView.classList.add("hidden");registerView.classList.remove("hidden")}

/* AUTH */
async function login(){
  loginError.textContent="";
  const l=loginLogin.value.trim();
  const p=loginPassword.value;

  const { data } = await supabase
    .from("users").select("id,password").eq("login",l).single();

  if(!data||data.password!==p){
    loginError.textContent="–ù–µ–≤—ñ—Ä–Ω—ñ –¥–∞–Ω—ñ"; return;
  }
  localStorage.setItem("user_id",data.id);
  userId=data.id; initProfile();
}

async function register(){
  regError.textContent="";
  const l=regLogin.value.trim();
  const p=regPassword.value;

  const { data, error } = await supabase
    .from("users").insert({login:l,password:p}).select().single();

  if(error){regError.textContent="–õ–æ–≥—ñ–Ω –∑–∞–π–Ω—è—Ç–∏–π";return;}

  await supabase.from("balances")
    .insert({user_id:data.id,personal:0,farming:0});

  await supabase.from("withdraw_limits")
    .insert({user_id:data.id,personal_limit:500,farming_limit:1000});

  localStorage.setItem("user_id",data.id);
  userId=data.id; initProfile();
}

function logout(){localStorage.removeItem("user_id");location.reload();}

/* PROFILE */
async function initProfile(){
  loginView.classList.add("hidden");
  registerView.classList.add("hidden");
  profileView.classList.remove("hidden");
  await loadBalances();
  await loadLimits();
  await loadShop();
}

async function loadBalances(){
  const { data } = await supabase
    .from("balances").select("personal,farming")
    .eq("user_id",userId).single();
  balances=data;
  personal.textContent=data.personal;
  farming.textContent=data.farming;
}

async function loadLimits(){
  const { data } = await supabase
    .from("withdraw_limits").select("*")
    .eq("user_id",userId).single();
  limits=data;
}

/* SHOP */
async function loadShop(){
  const { data:items } = await supabase
    .from("shop_items").select("*").order("price");
  shop.innerHTML="";
  items.forEach(i=>{
    const disabled=balances.personal<i.price;
    shop.innerHTML+=`
      <div class="product">
        <h3>${i.title}</h3>
        <div class="price">${i.price} R$</div>
        <button ${disabled?"disabled":""}
          onclick="buy('${i.id}',${i.price})">–ö—É–ø–∏—Ç–∏</button>
        ${disabled?'<div class="error">–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∫–æ—à—Ç—ñ–≤</div>':""}
      </div>`;
  });
}

async function buy(id,price){
  if(balances.personal<price)return;
  overlay.style.display="flex";
  await new Promise(r=>setTimeout(r,500));

  balances.personal-=price;
  await supabase.from("balances")
    .update({personal:balances.personal})
    .eq("user_id",userId);

  await supabase.from("purchases")
    .insert({user_id:userId,item_id:id,price,from_balance:"personal"});

  personal.textContent=balances.personal;
  overlay.style.display="none";
  launchConfetti(price);
  loadShop();
}

/* WITHDRAW */
function canWithdraw(type,amount){
  if(type==="personal")
    return limits.personal_used+amount<=limits.personal_limit;
  return limits.farming_used+amount<=limits.farming_limit;
}

async function withdraw(){
  withdrawError.textContent="";
  const type=withdrawBalance.value;
  const amount=Number(withdrawAmount.value);
  const nick=robloxNick.value.trim();

  if(!nick||amount<=0){
    withdrawError.textContent="–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è";return;
  }
  if(balances[type]<amount){
    withdrawError.textContent="–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∫–æ—à—Ç—ñ–≤";return;
  }
  if(!canWithdraw(type,amount)){
    withdrawError.textContent="–ü–µ—Ä–µ–≤–∏—â–µ–Ω–æ –ª—ñ–º—ñ—Ç";return;
  }

  balances[type]-=amount;
  await supabase.from("balances")
    .update({[type]:balances[type]})
    .eq("user_id",userId);

  await supabase.from("withdraw_requests")
    .insert({user_id:userId,roblox_nick:nick,amount,from_balance:type});

  if(type==="personal") limits.personal_used+=amount;
  else limits.farming_used+=amount;

  await supabase
