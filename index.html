<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>Сайт</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:Arial;background:#0b1220;color:#e5e7eb}
.container{max-width:1000px;margin:40px auto;padding:20px}
.card{background:#020617;border-radius:18px;padding:20px;margin-bottom:20px}
input,select,button{width:100%;padding:12px;margin-top:10px;border-radius:12px;border:none}
input,select{background:#0f172a;color:white}
button{background:#6366f1;color:white;font-weight:bold;cursor:pointer}
.hidden{display:none}

.balance-box{display:flex;gap:20px;justify-content:space-between}

.shop-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px}
.product{background:#020617;padding:16px;border-radius:14px}

.list-item{
  display:flex;
  justify-content:space-between;
  background:#020617;
  padding:12px;
  border-radius:12px;
  margin-top:8px
}
.pending{color:#facc15}
.done{color:#22c55e}

/* MAIN BUTTONS */
.main-btn{
  display:flex;
  align-items:center;
  gap:8px;
  padding:12px 18px;
  border-radius:14px;
  color:white;
  font-weight:bold;
}
.main-btn img{width:18px;height:18px}
</style>
</head>
<body>

<div class="container">

<!-- LOGIN -->
<div class="card" id="loginView">
  <h2>Вхід</h2>
  <input id="loginLogin" placeholder="Логін">
  <input id="loginPassword" type="password" placeholder="Пароль">
  <button id="loginBtn">Увійти</button>
</div>

<!-- PROFILE -->
<div class="hidden" id="profileView">

  <!-- MAIN BUTTONS -->
  <div class="card">
    <h3>Корисне</h3>
    <div id="mainButtons" style="display:flex;gap:12px;flex-wrap:wrap"></div>
  </div>

  <!-- BALANCE -->
  <div class="card balance-box">
    <div>Особистий: <b id="personal">0</b></div>
    <div>Фармилка: <b id="farming">0</b></div>
  </div>

  <!-- SHOP -->
  <div class="card">
    <h3>Магазин</h3>
    <div class="shop-grid" id="shop"></div>
  </div>

  <!-- WITHDRAW -->
  <div class="card">
    <h3>Зняти</h3>
    <select id="withdrawBalance">
      <option value="personal">Особистий</option>
      <option value="farming">Фармилка</option>
    </select>
    <input id="robloxNick" placeholder="Roblox нік">
    <input id="withdrawAmount" type="number" placeholder="Сума">
    <button id="withdrawBtn">Зняти</button>
  </div>

  <!-- HISTORY -->
  <div class="card">
    <h3>Історія зняттів</h3>
    <div id="withdrawHistory"></div>
  </div>

  <div class="card">
    <h3>Історія покупок</h3>
    <div id="purchaseHistory"></div>
  </div>

</div>
</div>

<script>
const supabase = supabase.createClient(
  "https://yknskbeqyahkxwceqflr.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlrbnNrYmVxeWFoa3h3Y2VxZmxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5NzA1OTAsImV4cCI6MjA4NDU0NjU5MH0.UaGcGRMdcPHv9bujNEtSjoL6OYy6XnmpxgWR9W2029M"
);

let userId=null, balances={};

loginBtn.onclick = async ()=>{
  const { data } = await supabase
    .from("users")
    .select("id,password")
    .eq("login",loginLogin.value)
    .single();

  if(!data || data.password!==loginPassword.value) return;

  userId=data.id;
  loginView.classList.add("hidden");
  profileView.classList.remove("hidden");
  loadAll();
};

async function loadAll(){
  const b = await supabase.from("balances")
    .select("*").eq("user_id",userId).single();
  balances=b.data;
  personal.textContent=balances.personal;
  farming.textContent=balances.farming;

  loadMainButtons();
  loadShop();
  loadWithdrawHistory();
  loadPurchaseHistory();
}

/* MAIN BUTTONS */
async function loadMainButtons(){
  const { data } = await supabase
    .from("main_buttons")
    .select("*")
    .eq("active",true)
    .order("sort");

  mainButtons.innerHTML="";
  data.forEach(btn=>{
    const b=document.createElement("button");
    b.className="main-btn";
    b.style.background=btn.color;
    if(btn.icon){
      if(btn.icon.startsWith("http")){
        const img=document.createElement("img");
        img.src=btn.icon;
        b.appendChild(img);
      }else{
        const s=document.createElement("span");
        s.textContent=btn.icon;
        b.appendChild(s);
      }
    }
    const t=document.createElement("span");
    t.textContent=btn.title;
    b.appendChild(t);
    b.onclick=()=>window.open(btn.link,"_blank");
    mainButtons.appendChild(b);
  });
}

/* SHOP */
async function loadShop(){
  const { data } = await supabase.from("shop_items").select("*");
  shop.innerHTML="";
  data.forEach(i=>{
    shop.innerHTML+=`
      <div class="product">
        <b>${i.title}</b>
        <div>${i.price>0?i.price+" R$":"Безкоштовно"}</div>
        <button onclick="buy('${i.id}',${i.price},'${i.buy_link||""}')">
          ${i.price===0 && i.buy_link?"Перейти":"Купити"}
        </button>
      </div>`;
  });
}

window.buy = async(id,price,link)=>{
  if(price===0 && link){
    window.open(link,"_blank");return;
  }
  if(balances.personal<price) return;

  balances.personal-=price;
  await supabase.from("balances")
    .update({personal:balances.personal})
    .eq("user_id",userId);

  await supabase.from("purchases")
    .insert({user_id:userId,item_id:id,price});

  personal.textContent=balances.personal;
  loadPurchaseHistory();
};

/* WITHDRAW */
withdrawBtn.onclick = async ()=>{
  const amount=Number(withdrawAmount.value);
  const type=withdrawBalance.value;
  if(amount<=0 || balances[type]<amount) return;

  balances[type]-=amount;
  await supabase.from("balances")
    .update({[type]:balances[type]})
    .eq("user_id",userId);

  await supabase.from("withdraw_requests")
    .insert({
      user_id:userId,
      roblox_nick:robloxNick.value,
      amount,
      from_balance:type
    });

  document.getElementById(type).textContent=balances[type];
  loadWithdrawHistory();
};

/* HISTORIES */
async function loadWithdrawHistory(){
  const { data } = await supabase
    .from("withdraw_requests")
    .select("*")
    .eq("user_id",userId)
    .order("created_at",{ascending:false});

  withdrawHistory.innerHTML="";
  data.forEach(r=>{
    withdrawHistory.innerHTML+=`
      <div class="list-item">
        <span>${r.roblox_nick} — ${r.amount}</span>
        <span class="${r.status==='done'?'done':'pending'}">
          ${r.status==='done'?'✅ виконано':'⏳ очікує'}
        </span>
      </div>`;
  });
}

async function loadPurchaseHistory(){
  const { data } = await supabase
    .from("purchases")
    .select("price,shop_items(title)")
    .eq("user_id",userId)
    .order("created_at",{ascending:false});

  purchaseHistory.innerHTML="";
  data.forEach(p=>{
    purchaseHistory.innerHTML+=`
      <div class="list-item">
        <span>${p.shop_items?.title||"Товар"}</span>
        <span>${p.price}</span>
      </div>`;
  });
}
</script>
</body>
</html>
