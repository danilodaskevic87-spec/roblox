<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>–°–∞–π—Ç</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="icon" href="favicon.png">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:Arial;background:#0b1220;color:#e5e7eb}
.hidden{display:none}
.container{max-width:900px;margin:40px auto;padding:20px}
.card{background:#020617;border-radius:22px;padding:25px;margin-bottom:25px}
input,select,button{width:100%;padding:14px;margin-top:10px;border-radius:14px;border:none}
input,select{background:#0f172a;color:white;border:1px solid #1e293b}
button{background:#6366f1;color:white;font-weight:bold;cursor:pointer}
button:disabled{background:#334155;color:#94a3b8}
.error{color:#f87171;font-size:14px;margin-top:6px}
.balance-box{display:flex;justify-content:space-between;gap:20px}
.shop-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px}
.product{background:#020617;padding:20px;border-radius:18px}
.price{color:#38bdf8;font-size:22px}
</style>
</head>
<body>

<div class="container">

<!-- LOGIN -->
<div class="card" id="loginView">
  <h2>–í—Ö—ñ–¥</h2>
  <input id="loginLogin" placeholder="–ù—ñ–∫ –∞–±–æ ID">
  <input id="loginPassword" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
  <button id="loginBtn">–£–≤—ñ–π—Ç–∏</button>
  <div class="error" id="loginError"></div>
  <p style="text-align:center">
    <a href="#" id="toRegister">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</a>
  </p>
</div>

<!-- REGISTER -->
<div class="card hidden" id="registerView">
  <h2>–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</h2>
  <input id="regLogin" placeholder="–ù—ñ–∫ –∞–±–æ ID">
  <input id="regPassword" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
  <button id="registerBtn">–°—Ç–≤–æ—Ä–∏—Ç–∏</button>
  <div class="error" id="regError"></div>
  <p style="text-align:center">
    <a href="#" id="toLogin">–ù–∞–∑–∞–¥</a>
  </p>
</div>

<!-- PROFILE -->
<div class="hidden" id="profileView">

  <div class="card balance-box">
    <div>–û—Å–æ–±–∏—Å—Ç–∏–π<br><b><span id="personal">0</span> R$</b></div>
    <div>–§–∞—Ä–º–∏–ª–∫–∞<br><b style="color:#22c55e"><span id="farming">0</span> R$</b></div>
  </div>

  <div class="card">
    <h2>–ú–∞–≥–∞–∑–∏–Ω</h2>
    <div class="shop-grid" id="shop"></div>
  </div>

  <div class="card">
    <h2>–ó–Ω—è—Ç–∏</h2>
    <select id="withdrawBalance">
      <option value="personal">–û—Å–æ–±–∏—Å—Ç–∏–π</option>
      <option value="farming">–§–∞—Ä–º–∏–ª–∫–∞</option>
    </select>
    <input id="robloxNick" placeholder="Roblox –Ω—ñ–∫">
    <input id="withdrawAmount" type="number" placeholder="–°—É–º–∞">
    <button id="withdrawBtn">–ó–Ω—è—Ç–∏</button>
    <div class="error" id="withdrawError"></div>
  </div>

  <button id="logoutBtn" style="background:#dc2626">–í–∏–π—Ç–∏</button>
</div>

</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {

  /* üîë SUPABASE */
  const supabase = window.supabase.createClient(
    "https://yknskbeqyahkxwceqflr.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlrbnNrYmVxeWFoa3h3Y2VxZmxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5NzA1OTAsImV4cCI6MjA4NDU0NjU5MH0.UaGcGRMdcPHv9bujNEtSjoL6OYy6XnmpxgWR9W2029M"
  );

  let userId = localStorage.getItem("user_id");
  let balances = {};
  let limits = {};

  const loginView = document.getElementById("loginView");
  const registerView = document.getElementById("registerView");
  const profileView = document.getElementById("profileView");

  /* VIEW SWITCH */
  document.getElementById("toRegister").onclick = e=>{
    e.preventDefault();
    loginView.classList.add("hidden");
    registerView.classList.remove("hidden");
  };
  document.getElementById("toLogin").onclick = e=>{
    e.preventDefault();
    registerView.classList.add("hidden");
    loginView.classList.remove("hidden");
  };

  /* LOGIN */
  document.getElementById("loginBtn").onclick = async ()=>{
    loginError.textContent="";
    const l = loginLogin.value.trim();
    const p = loginPassword.value;

    const { data } = await supabase
      .from("users").select("id,password")
      .eq("login",l).single();

    if(!data || data.password !== p){
      loginError.textContent="–ù–µ–≤—ñ—Ä–Ω—ñ –¥–∞–Ω—ñ";
      return;
    }

    localStorage.setItem("user_id",data.id);
    userId=data.id;
    initProfile();
  };

  /* REGISTER */
  document.getElementById("registerBtn").onclick = async ()=>{
    regError.textContent="";
    const l = regLogin.value.trim();
    const p = regPassword.value;

    const { data, error } = await supabase
      .from("users").insert({login:l,password:p})
      .select().single();

    if(error){
      regError.textContent="–õ–æ–≥—ñ–Ω –∑–∞–π–Ω—è—Ç–∏–π";
      return;
    }

    await supabase.from("balances")
      .insert({user_id:data.id,personal:0,farming:0});

    await supabase.from("withdraw_limits")
      .insert({user_id:data.id,personal_limit:500,farming_limit:1000});

    localStorage.setItem("user_id",data.id);
    userId=data.id;
    initProfile();
  };

  /* LOGOUT */
  document.getElementById("logoutBtn").onclick = ()=>{
    localStorage.removeItem("user_id");
    location.reload();
  };

  async function initProfile(){
    loginView.classList.add("hidden");
    registerView.classList.add("hidden");
    profileView.classList.remove("hidden");

    await loadBalances();
    await loadLimits();
    await loadShop();
  }

  async function loadBalances(){
    const { data } = await supabase
      .from("balances").select("*")
      .eq("user_id",userId).single();
    balances=data;
    personal.textContent=data.personal;
    farming.textContent=data.farming;
  }

  async function loadLimits(){
    const { data } = await supabase
      .from("withdraw_limits").select("*")
      .eq("user_id",userId).single();
    limits=data;
  }

  async function loadShop(){
    const { data:items } = await supabase
      .from("shop_items").select("*").order("price");

    shop.innerHTML="";
    items.forEach(i=>{
      const disabled = balances.personal < i.price;
      shop.innerHTML+=`
        <div class="product">
          <h3>${i.title}</h3>
          <div class="price">${i.price} R$</div>
          <button ${disabled?"disabled":""}
            onclick="buy('${i.id}',${i.price})">
            –ö—É–ø–∏—Ç–∏
          </button>
          ${disabled?'<div class="error">–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∫–æ—à—Ç—ñ–≤</div>':""}
        </div>`;
    });
  }

  window.buy = async (id,price)=>{
    if(balances.personal < price) return;

    balances.personal -= price;
    await supabase.from("balances")
      .update({personal:balances.personal})
      .eq("user_id",userId);

    await supabase.from("purchases")
      .insert({user_id:userId,item_id:id,price,from_balance:"personal"});

    personal.textContent=balances.personal;
    loadShop();
  };

  document.getElementById("withdrawBtn").onclick = async ()=>{
    withdrawError.textContent="";
    const type = withdrawBalance.value;
    const amount = Number(withdrawAmount.value);
    const nick = robloxNick.value.trim();

    if(!nick || amount<=0){
      withdrawError.textContent="–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ø–æ–ª—è";
      return;
    }
    if(balances[type] < amount){
      withdrawError.textContent="–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∫–æ—à—Ç—ñ–≤";
      return;
    }

    balances[type]-=amount;
    await supabase.from("balances")
      .update({[type]:balances[type]})
      .eq("user_id",userId);

    await supabase.from("withdraw_requests")
      .insert({user_id:userId,roblox_nick:nick,amount,from_balance:type});

    document.getElementById(type).textContent=balances[type];
  };

  if(userId) initProfile();
});
</script>
</body>
</html>
